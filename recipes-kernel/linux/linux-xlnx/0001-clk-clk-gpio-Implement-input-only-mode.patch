From 39016e57e604314397abad7c610331163f5c8b75 Mon Sep 17 00:00:00 2001
From: Mike Looijmans <mike.looijmans@topic.nl>
Date: Tue, 31 Aug 2021 08:52:45 +0200
Subject: [PATCH] clk: clk-gpio: Implement input-only mode

clk-gpio normally only controls the output. This patch enables the driver to
read the current state of the GPIO pin and use that as a default. The GPIO value
can be preset by a bootloader or pull-up resistor for example.

Signed-off-by: Mike Looijmans <mike.looijmans@topic.nl>
---
 drivers/clk/clk-gpio.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/drivers/clk/clk-gpio.c b/drivers/clk/clk-gpio.c
index 38755a241ab7..c8e86cd8bcc1 100644
--- a/drivers/clk/clk-gpio.c
+++ b/drivers/clk/clk-gpio.c
@@ -199,6 +199,7 @@ static int gpio_clk_driver_probe(struct platform_device *pdev)
 	struct gpio_desc *gpiod;
 	struct clk_hw *hw;
 	bool is_mux;
+	bool is_input;
 	int ret;
 
 	is_mux = of_device_is_compatible(node, "gpio-mux-clock");
@@ -209,8 +210,11 @@ static int gpio_clk_driver_probe(struct platform_device *pdev)
 		return -EINVAL;
 	}
 
+
+	is_input = of_property_read_bool(node, "input");
 	gpio_name = is_mux ? "select" : "enable";
-	gpiod = devm_gpiod_get(dev, gpio_name, GPIOD_OUT_LOW);
+	gpiod = devm_gpiod_get(dev, gpio_name,
+			is_input ? GPIOD_IN: GPIOD_OUT_LOW);
 	if (IS_ERR(gpiod)) {
 		ret = PTR_ERR(gpiod);
 		if (ret == -EPROBE_DEFER)
-- 
2.17.1

