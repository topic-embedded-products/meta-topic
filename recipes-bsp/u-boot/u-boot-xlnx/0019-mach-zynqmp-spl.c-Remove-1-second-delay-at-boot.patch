From fec9a2a5678fa87864970a9410ee53d72e0bd24c Mon Sep 17 00:00:00 2001
From: Mike Looijmans <mike.looijmans@topic.nl>
Date: Tue, 26 May 2020 08:40:17 +0200
Subject: [PATCH 19/26] mach-zynqmp/spl.c: Remove 1-second delay at boot

SPL boot is slow on the zynqMP because of this delay. The initialization done
in psu_init no longer requires an external delay, so this can be removed to
speed up the SPL boot flow considerably.

This causes the SD card boot to fail, so when boot mode is set to SD card,
delay for 1s to work around this.

Signed-off-by: Mike Looijmans <mike.looijmans@topic.nl>
---
 arch/arm/mach-zynqmp/spl.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/arch/arm/mach-zynqmp/spl.c b/arch/arm/mach-zynqmp/spl.c
index fb6a6c05f3..f77f0cb6a4 100644
--- a/arch/arm/mach-zynqmp/spl.c
+++ b/arch/arm/mach-zynqmp/spl.c
@@ -26,8 +26,6 @@ void board_init_f(ulong dummy)
 	debug_uart_init();
 	puts("Debug uart enabled\n"); /* or printch() */
 #endif
-	/* Delay is required for clocks to be propagated */
-	udelay(1000000);
 }
 
 static void ps_mode_reset(ulong mode)
@@ -105,6 +103,8 @@ u32 spl_boot_device(void)
 #ifdef CONFIG_SPL_MMC_SUPPORT
 	case SD_MODE1:
 	case SD1_LSHFT_MODE: /* not working on silicon v1 */
+		/* Without this SD boot fails */
+		udelay(1000000);
 		return BOOT_DEVICE_MMC2;
 	case SD_MODE:
 	case EMMC_MODE:
-- 
2.17.1

