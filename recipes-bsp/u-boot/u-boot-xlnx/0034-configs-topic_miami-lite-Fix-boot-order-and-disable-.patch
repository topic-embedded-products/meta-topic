From 2fda19c4b867b22792199d147e7f3b241c1570d5 Mon Sep 17 00:00:00 2001
From: Mike Looijmans <mike.looijmans@topic.nl>
Date: Mon, 18 Jan 2021 08:30:11 +0100
Subject: [PATCH 34/34] configs, topic_miami[lite]: Fix boot order and disable
 BOARD_LATE_INIT

The BOARD_LATE_INIT option for the Xilinx zynq prepends the boot_targets with
the current device. For the mimai board, we want a fixed order: First try
booting with mmc0 (SD card), then try QSPI, regardless of the boot switch
setting. This is especially important for the miamilite which does not have
bootswitches.

Fix boot order, "qspi0" should be "qpsi", don't try JTAG first, and remove
"usb1" which doesn't exist.
---
 configs/topic_miami_defconfig     | 1 +
 configs/topic_miamilite_defconfig | 1 +
 include/configs/topic_miami.h     | 2 +-
 3 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/configs/topic_miami_defconfig b/configs/topic_miami_defconfig
index 350b9ac74e..1c3483d5f5 100644
--- a/configs/topic_miami_defconfig
+++ b/configs/topic_miami_defconfig
@@ -11,6 +11,7 @@ CONFIG_DEBUG_UART_BASE=0xe0000000
 CONFIG_DEBUG_UART_CLOCK=100000000
 CONFIG_BOOT_INIT_FILE="board/topic/zynq/zynq-topic-miami/ps7_regs.txt"
 CONFIG_DEBUG_UART=y
+# CONFIG_BOARD_LATE_INIT is not set
 CONFIG_DISTRO_DEFAULTS=y
 CONFIG_SYS_CUSTOM_LDSCRIPT=y
 CONFIG_SYS_LDSCRIPT="arch/arm/mach-zynq/u-boot.lds"
diff --git a/configs/topic_miamilite_defconfig b/configs/topic_miamilite_defconfig
index e2a977226f..a34446ecde 100644
--- a/configs/topic_miamilite_defconfig
+++ b/configs/topic_miamilite_defconfig
@@ -11,6 +11,7 @@ CONFIG_DEBUG_UART_BASE=0xe0000000
 CONFIG_DEBUG_UART_CLOCK=100000000
 CONFIG_BOOT_INIT_FILE="board/topic/zynq/zynq-topic-miamilite/ps7_regs.txt"
 CONFIG_DEBUG_UART=y
+# CONFIG_BOARD_LATE_INIT is not set
 CONFIG_DISTRO_DEFAULTS=y
 CONFIG_SYS_CUSTOM_LDSCRIPT=y
 CONFIG_SYS_LDSCRIPT="arch/arm/mach-zynq/u-boot.lds"
diff --git a/include/configs/topic_miami.h b/include/configs/topic_miami.h
index 669ecab26c..7d1fb99384 100644
--- a/include/configs/topic_miami.h
+++ b/include/configs/topic_miami.h
@@ -90,7 +90,7 @@
 	"boot_a_script=load ${devtype} ${devnum}:${distro_bootpart} ${scriptaddr} ${prefix}${script}; source ${scriptaddr}\0" \
 	"boot_prefixes=/ /boot/\0" \
 	"boot_scripts=boot.scr\0" \
-	"boot_targets=jtag mmc0 qspi0 usb0 usb1\0" \
+	"boot_targets=mmc0 qspi usb0\0" \
 	"bootcmd_jtag=source $scriptaddr; echo SCRIPT FAILED: continuing...;\0" \
 	"bootcmd_mmc0=setenv devnum 0; run mmc_boot\0" \
 	"bootcmd_mmc1=setenv devnum 1; run mmc_boot\0" \
-- 
2.17.1

