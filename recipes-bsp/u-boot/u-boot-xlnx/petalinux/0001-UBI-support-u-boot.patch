From 98dad63453925d41beccee1bbcbc5f8e069a6580 Mon Sep 17 00:00:00 2001
From: Marc Brakels <marc.brakels@topic.nl>
Date: Fri, 5 Mar 2021 15:47:49 +0100
Subject: [PATCH 1/2] UBI support u-boot

%% original patch: 0001-UBI-support-u-boot.patch
---
 include/configs/zynq-common.h | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/include/configs/zynq-common.h b/include/configs/zynq-common.h
index d0614d8da4..0106776ab4 100644
--- a/include/configs/zynq-common.h
+++ b/include/configs/zynq-common.h
@@ -147,10 +147,11 @@
 #endif
 
 #define BOOTENV_DEV_QSPI(devtypeu, devtypel, instance) \
-	"bootcmd_qspi=sf probe 0 0 0 && " \
-		      "sf read ${scriptaddr} ${script_offset_f} ${script_size_f} && " \
-		      "echo QSPI: Trying to boot script at ${scriptaddr} && " \
-		      "source ${scriptaddr}; echo QSPI: SCRIPT FAILED: continuing...;\0"
+	"bootcmd_ubi=run ubi_mount && ubifsload ${scriptaddr} /boot/boot.scr && source ${scriptaddr}\0" \
+	"ubi_mount=sf probe && ubi part qspi-rootfs && ubifsmount ubi0:qspi-rootfs && setenv devtype ubi\0" \
+	"bootubipart=qspi-rootfs\0" \
+	"bootubivol=qspi-rootfs\0" \
+	"bootcmd_qspi=run bootcmd_ubi; echo QSPI: UBI FAILED: continuing...;\0"
 
 #define BOOTENV_DEV_NAME_QSPI(devtypeu, devtypel, instance) \
 	"qspi "
@@ -200,13 +201,14 @@
 #define CONFIG_EXTRA_ENV_SETTINGS	\
 	"fdt_high=0x20000000\0"		\
 	"initrd_high=0x20000000\0"	\
-	"scriptaddr=0x20000\0"	\
 	"script_size_f=0x40000\0"	\
 	"fdt_addr_r=0x1f00000\0"        \
 	"pxefile_addr_r=0x2000000\0"    \
 	"kernel_addr_r=0x2000000\0"     \
 	"scriptaddr=0x3000000\0"        \
 	"ramdisk_addr_r=0x3100000\0"    \
+	"mtdids=" CONFIG_MTDIDS_DEFAULT "\0" \
+	"mtdparts=" CONFIG_MTDPARTS_DEFAULT "\0" \
 	DFU_ALT_INFO \
 	BOOTENV
 #endif
-- 
2.17.1

