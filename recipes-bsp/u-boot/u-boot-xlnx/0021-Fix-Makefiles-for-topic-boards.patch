From 6167f0ec511a8ec840c2156f2b32495b5ae63e29 Mon Sep 17 00:00:00 2001
From: Mike Looijmans <mike.looijmans@topic.nl>
Date: Fri, 19 Jun 2020 11:38:10 +0200
Subject: [PATCH 21/26] Fix Makefiles for topic boards

---
 board/topic/zynq/Makefile   | 14 ++++++++++++--
 board/topic/zynqmp/Makefile |  7 ++++++-
 2 files changed, 18 insertions(+), 3 deletions(-)

diff --git a/board/topic/zynq/Makefile b/board/topic/zynq/Makefile
index becadd2ca7..77437138a7 100644
--- a/board/topic/zynq/Makefile
+++ b/board/topic/zynq/Makefile
@@ -1,8 +1,18 @@
 # SPDX-License-Identifier: GPL-2.0+
 
 obj-y	:= board.o
+obj-y	+= ../../xilinx/common/board.o
 
-# Remove quotes
-hw-platform-y :=$(shell echo $(CONFIG_DEFAULT_DEVICE_TREE))
+DEVICE_TREE ?= $(CONFIG_DEFAULT_DEVICE_TREE:"%"=%)
+ifeq ($(DEVICE_TREE),)
+DEVICE_TREE := unset
+endif
+hw-platform-y :=$(shell echo $(DEVICE_TREE))
 
 obj-$(CONFIG_SPL_BUILD) += $(hw-platform-y)/ps7_init_gpl.o
+
+ifndef CONFIG_SPL_BUILD
+obj-$(CONFIG_CMD_ZYNQ) += ../../xilinx/zynq/cmds.o
+obj-$(CONFIG_CMD_ZYNQ_RSA) += ../../xilinx/zynq/bootimg.o
+endif
+
diff --git a/board/topic/zynqmp/Makefile b/board/topic/zynqmp/Makefile
index 534907baab..be920cbc2f 100644
--- a/board/topic/zynqmp/Makefile
+++ b/board/topic/zynqmp/Makefile
@@ -6,8 +6,13 @@
 #
 
 obj-y := zynqmp.o
+obj-y += ../../xilinx/common/board.o
 
-hw-platform-y := $(shell echo $(CONFIG_DEFAULT_DEVICE_TREE))
+DEVICE_TREE ?= $(CONFIG_DEFAULT_DEVICE_TREE:"%"=%)
+ifeq ($(DEVICE_TREE),)
+DEVICE_TREE := unset
+endif
+hw-platform-y :=$(shell echo $(DEVICE_TREE))
 
 obj-$(CONFIG_SPL_BUILD) += $(hw-platform-y)/psu_init_gpl.o
 
-- 
2.17.1

